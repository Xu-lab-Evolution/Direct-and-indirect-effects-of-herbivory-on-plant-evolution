---
title: "nutrients and physiochemical parameters"
author: "Sara Nouere"
output: html_document
---
## Introduction
This document analyzes total phosphurus concentration, other nutrient concentrations and physiochemical parameters. It includes:

- Data loading and summarization,
- Plotting TP over time,
- Running linear mixed-effects models to assess treatment effects at early and late timepoints for nutrient concentrations and physiochemical parameters .

**Note:** This R Markdown document is used to generate **Figure 1B** in the manuscript, and **Table S6** in the supplementary.

### Figure 1B
## Load required libraries

```{r,echo=FALSE, message=FALSE, warning=FALSE}
library("dplyr")
library("ggplot2")
library("plotrix")
library("readxl")
library("car")
library("lme4")
```

## Load, summarize data and transformation function for custom X-Axis

```{r,echo=FALSE, message=FALSE, warning=FALSE}
df <- read.table("datanutrients.txt", sep = "\t", header = TRUE)

mdata.plot <- df %>%
  group_by(year, timepoint, treatment) %>%
  summarise(TP_av = mean(TP),
            TP_se = std.error(TP),
            .groups = 'drop')

# Transformation function
transform_x <- function(x) {
  ifelse(x < 18, x, 
         ifelse(x >= 18 & x <= 48, 18 + (x - 18) / 15, 
                18 + (48 - 18) / 15 + (x - 48) * 1))
}   
```

## Precompute starting values 

```{r,echo=FALSE, message=FALSE, warning=FALSE}
control_start_TP <- mdata.plot$TP_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 0]
control_end_TP <- mdata.plot$TP_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 7]
herbivory_start_TP <- mdata.plot$TP_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 0]
herbivory_end_TP <- mdata.plot$TP_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 7]
```

## Plot: TP over time by treatment

```{r,echo=FALSE, message=FALSE, warning=FALSE}
px1B <- ggplot(mdata.plot, aes(x = transform_x(timepoint), y = TP_av, color = treatment)) +
  theme_bw(base_size = 14) +
  geom_pointrange(aes(ymin = TP_av - TP_se, ymax = TP_av + TP_se), position = position_dodge(0.9)) +
  theme(axis.title.x = element_text(color = "black"),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        axis.title.y = element_text(color = "black"),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(name = "Legend", values = c("#0072B2", "#D55E00"),
                     labels = c("Control", "Herbivory"),
                     breaks = c("Control", "Herbivory")) +
  scale_x_continuous(
    breaks = transform_x(c(0, 3, 6, 9, 12, 15, 18, 48, 51, 54, 57, 60, 63)),
    labels = c("0", "3", "6", "9", "12", "15", "18", "48", "51", "54", "57", "60", "63")
  ) +
  expand_limits(x = c(0, transform_x(65)), y = 0) +
  geom_rect(aes(xmin = transform_x(18), xmax = transform_x(48), ymin = -Inf, ymax = Inf),
            fill = "#B0B0B0", color = "transparent", inherit.aes = FALSE) +

  geom_segment(data = mdata.plot,
               aes(x = transform_x(0) - 0.2, xend = transform_x(5) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 0],
                   yend = TP_av[treatment == "Control" & timepoint == 5]),
               color = "#0072B2") +
   geom_segment(data = mdata.plot,
               aes(x = transform_x(5) - 0.2, xend = transform_x(7) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 5],
                   yend = TP_av[treatment == "Control" & timepoint == 7]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(7) - 0.2, xend = transform_x(11) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 7],
                   yend = TP_av[treatment == "Control" & timepoint == 11]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(11) - 0.2, xend = transform_x(13) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 11],
                   yend = TP_av[treatment == "Control" & timepoint == 13]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(0) + 0.2, xend = transform_x(5) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 0],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 5]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(5) + 0.2, xend = transform_x(7) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 5],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 7]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(7) + 0.2, xend = transform_x(11) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 7],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 11]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(11) + 0.2, xend = transform_x(13) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 11],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 13]),
               color = "#D55E00") +
  
  geom_segment(aes(x = transform_x(13), xend = transform_x(51),
                   y = TP_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 13],
                   yend = TP_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 51]),
               color = "#0072B2", linetype = "dashed") +
  
  geom_segment(aes(x = transform_x(13), xend = transform_x(51),
                   y = TP_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 13],
                   yend = TP_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 51]),
               color = "#D55E00", linetype = "dashed") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(51) - 0.2, xend = transform_x(54) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 51],
                   yend = TP_av[treatment == "Control" & timepoint == 54]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(54) - 0.2, xend = transform_x(59) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 54],
                   yend = TP_av[treatment == "Control" & timepoint == 59]),
               color = "#0072B2") +
  
  geom_segment(data = mdata.plot,
               aes(x = transform_x(59) - 0.2, xend = transform_x(61) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 59],
                   yend = TP_av[treatment == "Control" & timepoint == 61]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(61) - 0.2, xend = transform_x(63) - 0.2,
                   y = TP_av[treatment == "Control" & timepoint == 61],
                   yend = TP_av[treatment == "Control" & timepoint == 63]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(51) + 0.2, xend = transform_x(54) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 51],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 54]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(54) + 0.2, xend = transform_x(59) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 54],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 59]),
               color = "#D55E00") +
  
  geom_segment(data = mdata.plot,
               aes(x = transform_x(59) + 0.2, xend = transform_x(61) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 59],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 61]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(61) + 0.2, xend = transform_x(63) + 0.2,
                   y = TP_av[treatment == "Herbivory" & timepoint == 61],
                   yend = TP_av[treatment == "Herbivory" & timepoint == 63]),
               color = "#D55E00") +
  
  labs(x = "Time (weeks)",
       y = "Total Phosphorus concentration")

px1B
```

## Statistical analysis: first growing season (weeks 7–13)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
# Filter first growing season data
df1 <- df %>%
  filter(timepoint %in% c(7, 11, 13))

# Mixed-effects model for first growing season
model <- lmer(TP ~ treatment + (1 | timepoint) + (1 | pond), data = df1)

# Model summary and ANOVA
Anova(model, test = "F")
summary(model)
```

## Statistical analysis: second growing season (weeks 59–63)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
# Filter second growing season data
df2 <- df %>%
  filter(timepoint %in% c(59, 61, 63))

# Mixed-effects model for second growing season
model <- lmer(TP ~ treatment + (1 | timepoint) + (1 | pond), data = df2)

# Model summary and ANOVA
Anova(model, test = "F")
summary(model)
```

### Table S6
## Statistical analysis: first growing season (weeks 7–13)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
# PO4
model <- lmer(PO4 ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# NH4
model <- lmer(NH4 ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# TOC
model <- lmer(TOC ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# pH
model <- lmer(pH ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# Temperature
model <- lmer(Temp ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# O2
model <- lmer(O2pourcentage ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# Conductivity
model <- lmer(Cond ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)

# Light
model <- lmer(light_weekly_mean ~ treatment + (1 | timepoint) + (1 | pond), data = df1)
Anova(model, test = "F")
summary(model)
```

## Statistical analysis: second growing season (weeks 59–63)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
# PO4
model <- lmer(PO4 ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# NH4
model <- lmer(NH4 ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# TOC
model <- lmer(TOC ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# pH
model <- lmer(pH ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# Temperature
model <- lmer(Temp ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# O2
model <- lmer(O2pourcentage ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# Conductivity
model <- lmer(Cond ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)

# Light
model <- lmer(light_weekly_mean ~ treatment + (1 | timepoint) + (1 | pond), data = df2)
Anova(model, test = "F")
summary(model)
```

