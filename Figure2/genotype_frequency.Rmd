---
title: "Genotype frequencies"
author: "Sara Nouere"
date: "2025-05-02"
output: html_document
---

## Introduction

This document:

- Loads and filters genotype data,
- Normalizes and reshapes data for analysis,
- Runs a mixed-effects model to examine treatment Ã— genotype Ã— pond Ã— week effects,
- Produces:
    - **Circular bar plots (Figures 2A & 2B)**,
    - **Per-genotype time series plots (Figures 2Câ€“F + Supplementary)**,
- Runs **PERMANOVA** for overall treatment effects.

## Load Required Libraries

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(reshape2)
library(ggplot2)
library(lme4)
library(car)
library(emmeans)
library(cowplot)
library(ggpubr)
library(plotrix)
library(ggforce)
library(vegan)
library(tidyverse)
library(tidyr)
library(viridis)
library(scales)
library(ggrepel)
```

## Genotype List and Filtering

```{r, echo=FALSE, message=FALSE, warning=FALSE}
genotype.list <- c("Sp020", "Sp021", "Sp023", "Sp027", "Sp029", "Sp031", "Sp034", "Sp042", "Sp049", "Sp056",
                   "Sp058", "Sp062", "Sp065", "Sp066", "Sp067", "Sp070", "Sp074", "Sp102", "Sp103", "SP190",
                   "SP193", "SP214", "SP217", "SP219")


single.gen.fun <- function(x){
  df.genotype <- read.table(paste0("data/", x, ".txt"))
  colnames(df.genotype) <- c("position", "begin", "end", genotype.list)
  df.genotype <- df.genotype %>% filter_at(x, any_vars(. > 0.50))
  df.genotype$position <- paste(df.genotype$position, df.genotype$begin, df.genotype$end, sep = "_")
  return(df.genotype$position)
}

sg.tab <- sapply(genotype.list, single.gen.fun, simplify = FALSE, USE.NAMES = TRUE)
sg.count <- table(unlist(lapply(sg.tab, unique)))
sg.count <- as.data.frame(sg.count) %>% arrange(desc(Freq)) %>% as_tibble() %>% slice(1:10)
```

## Data Import and Processing

```{r, echo=FALSE, message=FALSE, warning=FALSE}
files <- dir(path = "data", pattern = "EW*")

data <- sapply(files, function(x){
  raw.data <- read.table(paste0("data/", x))
  colnames(raw.data) <- c("position", "begin", "end", genotype.list)
  raw.data$position <- paste(raw.data$position, raw.data$begin, raw.data$end, sep = "_")
  raw.data$sample <- paste0(x)
  raw.data$sample  <- sub('\\.[^.]+$', '', raw.data$sample)
  raw.data$begin <- NULL
  raw.data$end <- NULL
  return(raw.data)},
  simplify = FALSE,USE.NAMES = TRUE)

data <- Reduce(function(x,y) {rbind(x,y)}, data)
data <- data[which(data$position %in% sg.count$Var1),] ### THIS ONE TO ALLOW FILTERING
data$position <- NULL

df <- data %>% group_by(sample) %>% summarize(Sp020 = mean(Sp020),
                                              Sp021 = mean(Sp021),
                                              Sp023 = mean(Sp023),
                                              Sp027 = mean(Sp027),
                                              Sp029 = mean(Sp029),
                                              Sp031 = mean(Sp031),
                                              Sp034 = mean(Sp034),
                                              Sp042 = mean(Sp042),
                                              Sp049 = mean(Sp049),
                                              Sp056 = mean(Sp056),
                                              Sp058 = mean(Sp058),
                                              Sp062 = mean(Sp062),
                                              Sp065 = mean(Sp065),
                                              Sp066 = mean(Sp066),
                                              Sp067 = mean(Sp067),
                                              Sp070 = mean(Sp070),
                                              Sp074 = mean(Sp074),
                                              Sp102 = mean(Sp102),
                                              Sp103 = mean(Sp103),
                                              SP190 = mean(SP190),
                                              SP193 = mean(SP193),
                                              SP214 = mean(SP214),
                                              SP217 = mean(SP217),
                                              SP219 = mean(SP219))

metadata <- read.csv("data/metadata.csv", header = T)

df2 <- merge(metadata, df, by = "sample")
#mdata <- melt(df2, id=c("sample", "type", "category", "ID_pond", "treatment","week")) 
mdata <- reshape2::melt(df2, id.vars = c("sample", "type", "category", "ID_pond", "treatment", "week"))
```

## Normalization and Data Preparation

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mdata4 <- mdata[which(mdata$category == "control_w0"),]
mdata4 <- mdata4 %>% group_by(treatment, ID_pond, type, week, variable) %>% summarise(value = mean(value))
mdata4 <- mdata4[which(mdata4$type == "control_w0_mix"),]
mdata4 <- mdata4 %>% mutate(value = (1/24)/value)

mdata0 <- mdata[which(mdata$type == "control_w0_mix"),]
mdata0 <- merge(mdata0, mdata4, by = "variable") %>% mutate(value = value.x * value.y)
mdata0 <- mdata0 %>% select(sample, ID_pond.x, treatment.x, week.x, variable, value)
colnames(mdata0) <- c("sampleID", "pond", "treatment", "week", "genotype", "value")

mdata2 <- mdata[which(mdata$category == "experimental"),]
mdata2 <- merge(mdata2, mdata4, by = "variable") %>% mutate(value = value.x * value.y)
mdata2 <- mdata2 %>% select(sample, ID_pond.x, treatment.x, week.x, variable, value)
colnames(mdata2) <- c("sampleID", "pond", "treatment", "week", "genotype", "value")

mdata.df <- rbind(mdata0, mdata2)
```

## Mixed Model: Treatment Ã— Genotype + Pond + Week

```{r, echo=FALSE, message=FALSE, warning=FALSE}
mdata.df2 <- mdata.df[which(mdata.df$treatment != "other_sample"),]
model <- lmer(value ~ treatment * genotype + (1|pond) + (1|week), data = mdata.df2)
Anova(model, test.statistic = 'F')
```

## Circular Plot: Figures 2A and 2B

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Convert 'week' to numeric and exclude week 0
mdata.df$week_numeric <- as.numeric(gsub("w", "", mdata.df$week))
#mdata.df$week <- as.numeric(gsub("w", "", mdata.df$week))
mdata.df.filtered <- mdata.df %>% filter(week_numeric != 0)

# ðŸ”¹ Prepare data for all plots
genotype_data <- mdata.df.filtered %>%
  group_by(genotype, treatment, week_numeric) %>%
  summarize(mean_value = mean(value), .groups = "drop")

custom_colors <- c("control" = "#00afbb", "herbivory" = "#e41a1c")
custom_labels <- c("11" = "Week 11", "61" = "Week 61")

px6 <- ggplot(genotype_data, aes(x = genotype, y = mean_value, fill = treatment)) +
  geom_bar(stat = "identity") +
  coord_polar(start = 0) +  # Convert to circular
  facet_wrap(~week_numeric, labeller = as_labeller(custom_labels)) +  # Use custom labels
  scale_fill_manual(values = custom_colors) +
  scale_y_continuous(breaks = seq(0, max(genotype_data$mean_value), length.out = 3), 
                     labels = function(x) sprintf("%.2f", floor(x * 100) / 100)) +
  theme_minimal() +
  theme(panel.grid.major.y = element_line(size = 0.5),
        panel.grid.minor.y = element_blank(),
        plot.margin = margin(0, 20, 0, 20),
        axis.text.x = element_text(angle = 360, color = "black", size = 16),
        axis.text.y = element_text(size = 16, color = "black"),
        axis.title.y = element_text(size = 20, vjust = 3),
        legend.position = "none",
        panel.spacing = unit(2, "lines"),
        strip.text = element_text(size = 20, face ="bold")) +  # Increase facet label size
  labs(x = "", y = "Genotypes frequencies")

px6
```

## Per-Genotype Time Series: Figures 2Câ€“F + Supplementary

```{r, echo=FALSE, message=FALSE, warning=FALSE}
plot.fun <- function(gtype, ylabel, siglabel){
  mdata.plot <- mdata.df %>% filter(genotype == gtype)
  px <- ggplot(mdata.plot, aes(x = week, y = value, fill = treatment, color = treatment)) +  
    theme_bw(base_size = 14) +
    stat_summary(fun = mean, geom = "pointrange", fun.max = function(x) mean(x) + std.error(x), fun.min = function(x) mean(x) - std.error(x), position=position_dodge(0)) +
    theme(axis.title.x=element_blank(),
          axis.text.x = element_text(color="black"),
          axis.text.y = element_text(color="black"),
          axis.title.y = element_text(color="black"),
          legend.position = "none",
          panel.grid = element_blank()) +
    scale_fill_manual(name = "Legend", values=c("#252525", "#00afbb", "#e41a1c"), labels = c("Starting", "Control", "Herbivory"), breaks = c("other_sample", "control", "herbivory")) +
    scale_color_manual(name = "Legend", values=c("#252525", "#00afbb", "#e41a1c"), labels = c("Starting", "Control", "Herbivory"), breaks = c("other_sample", "control", "herbivory")) +
    scale_x_discrete(name = "Legend", labels = c("0", "11", "61"), breaks = c("w0", "w11", "w61")) +
    
    geom_segment(aes(x=1,xend=2,
                     y= mean(mdata.plot[which(mdata.plot$treatment == "other_sample" & mdata.plot$week == "w0"),]$value),
                     yend=mean(mdata.plot[which(mdata.plot$treatment == "control" & mdata.plot$week == "w11"),]$value)),
                 color = "#00afbb") +
    
    geom_segment(aes(x=2,xend=3,
                     y= mean(mdata.plot[which(mdata.plot$treatment == "control" & mdata.plot$week == "w11"),]$value),
                     yend=mean(mdata.plot[which(mdata.plot$treatment == "control" & mdata.plot$week == "w61"),]$value)),
                 color = "#00afbb") +
    
    geom_segment(aes(x=1,xend=2,
                     y= mean(mdata.plot[which(mdata.plot$treatment == "other_sample" & mdata.plot$week == "w0"),]$value),
                     yend=mean(mdata.plot[which(mdata.plot$treatment == "herbivory" & mdata.plot$week == "w11"),]$value)),
                 color = "#e41a1c") +
    
    
    geom_segment(aes(x=2,xend=3,
                     y= mean(mdata.plot[which(mdata.plot$treatment == "herbivory" & mdata.plot$week == "w11"),]$value),
                     yend=mean(mdata.plot[which(mdata.plot$treatment == "herbivory" & mdata.plot$week == "w61"),]$value)),
                 color = "#e41a1c") +
    
    
    annotate("text", x = 3.3, 
             y =  (mean(mdata.plot[which(mdata.plot$treatment == "control" & mdata.plot$week == "w61"),]$value) +
                     mean(mdata.plot[which(mdata.plot$treatment == "herbivory" & mdata.plot$week == "w61"),]$value))/2,
             label = paste0(siglabel), size = 1) +
    
    ggtitle(paste0(gtype)) +
    
    #ylim(0,1) +
    scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
    labs(y = paste0(ylabel))
  
  return(px)
}

px1 <- plot.fun("Sp020", "Genotype frequency", " ")
px2 <- plot.fun("Sp021", " ", " ")
px3 <- plot.fun("Sp023", " ", " ")
px4 <- plot.fun("Sp027", " ", " ")
px5 <- plot.fun("Sp029", " ", " ")
px6 <- plot.fun("Sp031", " ", " ")
px7 <- plot.fun("Sp034", " ", " ")
px8 <- plot.fun("Sp042", " ", " ")
px9 <- plot.fun("Sp049", "", " ")
px10 <- plot.fun("Sp056", " ", " ")
px11 <- plot.fun("Sp058", " ", " ")
px12 <- plot.fun("Sp062", " ", " ")
px13 <- plot.fun("Sp065", " ", " ")
px14 <- plot.fun("Sp066", " ", " ")
px15 <- plot.fun("Sp067", " ", " ")
px16 <- plot.fun("Sp070", " ", " ")
px17 <- plot.fun("Sp074", " ", " ")
px18 <- plot.fun("Sp102", " ", " ")
px19 <- plot.fun("Sp103", " ", " ")
px20 <- plot.fun("SP190", " ", " ")
px21 <- plot.fun("SP193", " ", " ")
px22 <- plot.fun("SP214", " ", " ")
px23 <- plot.fun("SP217", " ", " ")
px24 <- plot.fun("SP219", " ", " ")

px <- ggarrange(
  px1, px2, px3, px4, px5, px6,
  px7, px8, px9, px10, px11, px12,
  px13, px14, px15, px16, px17, px18,
  px19, px20, px21, px22, px23, px24,
  ncol = 4, nrow = 6,
  labels = c("a.", "b.", "c.", "d.", "e.", "f.",
             "g.", "h.", "i.", "j.", "k.", "l.",
             "m.", "n.", "o.", "p.", "q.", "r.",
             "s.", "t.", "u.", "v.", "w.", "x."),
  common.legend = TRUE,
  align = "hv",               # Align horizontal & vertical axes
  widths = rep(1, 4),         # Force equal widths for each column
  heights = rep(1, 6)         # Force equal heights for each row
)

px
```


