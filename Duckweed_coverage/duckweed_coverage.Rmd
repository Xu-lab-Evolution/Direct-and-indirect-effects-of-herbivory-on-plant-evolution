---
title: "Duckweed surface coverage"
author: "Sara Nouere"
output: html_document
---
## Introduction
This document analyzes duckweed surface coverage under different treatments. It includes:

- Data loading and summarization,
- Plotting duckweed coverage over time,
- Running linear mixed-effects models to assess treatment effects at early and late timepoints.
- Running linear mixed-effects model to assess the effect of snail herbivory on duckweed surface coverage in 2024.

**Note:** This R Markdown document is used to generate **Figure 2A** in the manuscript and **Table S2** in supplementary.

## Figure 2A
## Load required libraries

```{r,echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lme4)
library(car)
library(plotrix)
```

## Read data and summarize

```{r,echo=FALSE, message=FALSE, warning=FALSE}
df <- read.table("duckweedcoverage.txt", sep = "\t", header = TRUE)

mdata.plot <- df %>%
  group_by(year, timepoint, treatment) %>%
  summarise(
    coverage_av = mean(surface_coverage),
    coverage_se = std.error(surface_coverage),
    .groups = 'drop'
  )

```

## Transformation function

```{r,echo=FALSE, message=FALSE, warning=FALSE}
transform_x <- function(x) {
  ifelse(x < 18, x, 
         ifelse(x >= 18 & x <= 48, 18 + (x - 18) / 15, 
                18 + (48 - 18) / 15 + (x - 48) * 1))
}                          
```

## Generate the plot

```{r,echo=FALSE, message=FALSE, warning=FALSE}
# Precompute fixed values
control_start_coverage <- mdata.plot$coverage_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 0]
control_end_coverage <- mdata.plot$coverage_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 7]
herbivory_start_coverage <- mdata.plot$coverage_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 0]
herbivory_end_coverage <- mdata.plot$coverage_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 7]

px1A <- ggplot(mdata.plot, aes(x = transform_x(timepoint), y = coverage_av, color = treatment)) +
  theme_bw(base_size = 14) +
  geom_pointrange(aes(ymin = coverage_av - coverage_se, ymax = coverage_av + coverage_se), position = position_dodge(0.9)) +
  theme(axis.title.x = element_text(color = "black"),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        axis.title.y = element_text(color = "black"),
        panel.grid = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(name = "Legend", values = c("#0072B2", "#D55E00"),
                     labels = c("Control", "Herbivory"),
                     breaks = c("Control", "Herbivory")) +
  scale_x_continuous(
    breaks = transform_x(c(0, 3, 6, 9, 12, 15, 18, 48, 51, 54, 57, 60, 63)),
    labels = c("0", "3", "6", "9", "12", "15", "18", "48", "51", "54", "57", "60", "63")
  ) +
  expand_limits(x = c(0, transform_x(65)), y = 0) +
  geom_rect(aes(xmin = transform_x(18), xmax = transform_x(48), ymin = -Inf, ymax = Inf),
            fill = "#B0B0B0", color = "transparent", inherit.aes = FALSE) +
  geom_segment(aes(x = transform_x(0), xend = transform_x(7),
                   y = control_start_coverage,
                   yend = control_end_coverage),
               color = "#0072B2") +
  geom_segment(aes(x = transform_x(0), xend = transform_x(7),
                   y = herbivory_start_coverage,
                   yend = herbivory_end_coverage),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(7) - 0.2, xend = transform_x(11) - 0.2,
                   y = coverage_av[treatment == "Control" & timepoint == 7],
                   yend = coverage_av[treatment == "Control" & timepoint == 11]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(11) - 0.2, xend = transform_x(13) - 0.2,
                   y = coverage_av[treatment == "Control" & timepoint == 11],
                   yend = coverage_av[treatment == "Control" & timepoint == 13]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(7) + 0.2, xend = transform_x(11) + 0.2,
                   y = coverage_av[treatment == "Herbivory" & timepoint == 7],
                   yend = coverage_av[treatment == "Herbivory" & timepoint == 11]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(11) + 0.2, xend = transform_x(13) + 0.2,
                   y = coverage_av[treatment == "Herbivory" & timepoint == 11],
                   yend = coverage_av[treatment == "Herbivory" & timepoint == 13]),
               color = "#D55E00") +
  geom_segment(aes(x = transform_x(13), xend = transform_x(59),
                   y = coverage_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 13],
                   yend = coverage_av[mdata.plot$treatment == "Control" & mdata.plot$timepoint == 59]),
               color = "#0072B2", linetype = "dashed") +
  geom_segment(aes(x = transform_x(13), xend = transform_x(59),
                   y = coverage_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 13],
                   yend = coverage_av[mdata.plot$treatment == "Herbivory" & mdata.plot$timepoint == 59]),
               color = "#D55E00", linetype = "dashed") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(59) - 0.2, xend = transform_x(61) - 0.2,
                   y = coverage_av[treatment == "Control" & timepoint == 59],
                   yend = coverage_av[treatment == "Control" & timepoint == 61]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(61) - 0.2, xend = transform_x(63) - 0.2,
                   y = coverage_av[treatment == "Control" & timepoint == 61],
                   yend = coverage_av[treatment == "Control" & timepoint == 63]),
               color = "#0072B2") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(59) + 0.2, xend = transform_x(61) + 0.2,
                   y = coverage_av[treatment == "Herbivory" & timepoint == 59],
                   yend = coverage_av[treatment == "Herbivory" & timepoint == 61]),
               color = "#D55E00") +
  geom_segment(data = mdata.plot,
               aes(x = transform_x(61) + 0.2, xend = transform_x(63) + 0.2,
                   y = coverage_av[treatment == "Herbivory" & timepoint == 61],
                   yend = coverage_av[treatment == "Herbivory" & timepoint == 63]),
               color = "#D55E00") +
  labs(x = "Time (weeks)", y = "Duckweed coverage (%)")

px1A
```

## Statistical analysis
## First season: timepoints (weeks 7, 11, 13)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
df1 <- df %>%
  filter(timepoint %in% c(7, 11, 13))

model <- lmer(surface_coverage ~ treatment + (1|timepoint) +(1|pond), data = df1)
Anova(model, test = "F")
```

## Second Season: Timepoints (Weeks 59, 61, 63)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
df2 <- df %>%
  filter(timepoint %in% c(59, 61, 63))

model <- lmer(surface_coverage ~ treatment + (1|timepoint) +(1|pond), data = df2)
Anova(model, test = "F")
```

## Table S2: effect of snail herbivory on duckweed surface coverage in 2024

```{r,echo=FALSE, message=FALSE, warning=FALSE}

df3 <- df %>%
  filter(year == 2024, treatment == "Herbivory")

model <- lmer(surface_coverage ~ snail + (1|pond) + (1|timepoint), data = df3)
Anova(model, test = "F")

```
