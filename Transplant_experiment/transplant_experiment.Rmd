---
title: "Transplant experiment"
author: "Sara Nouere"
output: html_document
---
## Introduction

This R Markdown document analyzes the evolutionary and ecological responses of *Spirodela polyrhiza* to experimental snail herbivory, based on transplant experiments conducted in 2023 and 2024. It focuses on the relative growth rate of populations from different evolutionary backgrounds (control vs. herbivory ) when exposed to control or herbivory environments. The analyses support the generation of **Figure 4C** (main text) and **Figure S5** (supplementary material).

## Load required libraries

```{r,echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lme4)
library(car)
library(plotrix)
```

## Figure 4C: data preparation and relative growth rate (2023)

```{r,echo=FALSE, message=FALSE, warning=FALSE}

df <- read.table("data_transplantexp.txt", sep = "\t", header = TRUE)
df$rel.count <- (log(df$count_2w) - log(180)) / 14
df_filtered <- df %>% filter(!(population == "con" & origin_population == "Herbivory" & (host_environment == "Control" | host_environment == "Herbivory")))

mdata.plot <- df_filtered  %>%
  mutate(
    year = as.factor(year),
    population = tolower(population),
    population = factor(population, levels = c("mix", "con")),
    origin_population = factor(origin_population),
    host_environment = factor(host_environment, levels = c("Control", "Herbivory"))
  ) %>%
  group_by(year, population, origin_population, host_environment) %>%
  summarise(
    fitness_av = mean(rel.count, na.rm = TRUE),
    fitness_se = sd(rel.count, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )
```

## Figure 4C: plot 2023

```{r,echo=FALSE, message=FALSE, warning=FALSE}
color_palette <- c("Control" = "#0072B2", "Herbivory" = "#D55E00")
px4C2023 <- ggplot(mdata.plot, aes(x = host_environment, y = fitness_av,
                                    color = origin_population,
                                    shape = population)) +
  
  geom_pointrange(
    aes(ymin = fitness_av - fitness_se, ymax = fitness_av + fitness_se),
    position = position_dodge(0.4),
    size=0.7,
    na.rm = TRUE
  ) +
  
  facet_wrap(~ year, scales = "free_x", strip.position = "top") +  
  
  scale_color_manual(name = "Origin", values = color_palette) +
  scale_shape_manual(name = "Population Type", values = c("mix" = 16, "con" = 17)) +
  
  labs(
    x = "Host Environment",
    y = "Relative Growth Rate"
  ) +
  
  theme_classic(base_size = 14) +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 13),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1, "lines"),
    plot.margin = margin(10, 5, 10, 10)
  )
px4C2023
```

## Statistical analysis for figure 4C (2023)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
model <- lmer(rel.count ~ origin_population + host_environment + population +
                (1 | pond),
              data = df_filtered)
Anova(model, test ="F")
```

## Figure 4C: data preparation and relative growth rate (2024)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
df_filtered1 <- df %>% filter(year == 2024)

# Summarize by origin, host environment, and population type
mdata.plot1 <- df_filtered1 %>%
  group_by(population, origin_population, host_environment) %>%
  summarise(
    fitness_av = mean(rel.count, na.rm = TRUE),
    fitness_se = sd(rel.count, na.rm = TRUE) / sqrt(n())
  )
```

## Figure 4C: plot 2024

```{r,echo=FALSE, message=FALSE, warning=FALSE}
px4C2024 <- ggplot(mdata.plot1, aes(x = host_environment, y = fitness_av,
                              color = origin_population)) +
  geom_pointrange(aes(ymin = fitness_av - fitness_se, ymax = fitness_av + fitness_se),
                  position = position_dodge(0.3), size = 1) +
  theme_bw(base_size = 14) +
  theme(
    axis.title.x = element_text(color = "black", size = 14),
    axis.text.x = element_text(color = "black", size = 14),
    axis.text.y = element_text(color = "black", size = 14),
    axis.title.y = element_text(color = "black", size = 14),
    panel.grid = element_blank(),
    legend.position = "none"
  ) +
  scale_color_manual(
    name = "Origin Population",
    values = c("Control" = "#0072B2", "Herbivory" = "#D55E00")
  ) +
  labs(
    x = "Host Environment",
    y = "Relative Growth Rate"
  )

px4C2024
```

## Statistical analysis for figure 4C (2024)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
model1 <- lmer(rel.count ~ origin_population + host_environment +
                (1 | pond),
              data = df_filtered1)
Anova(model1, test ="F")
```

## Figure S5: data preparation for initial population 2023

```{r,echo=FALSE, message=FALSE, warning=FALSE}

df_filtered2 <- df %>%
  filter(population == "con")

mdata.plot2 <- df_filtered2 %>%
  group_by(year, origin_population, host_environment) %>%
  summarise(
    fitness_av = mean(rel.count),
    fitness_se = std.error(rel.count)
  )
```

## Figure S5: plot initial population 2023

```{r,echo=FALSE, message=FALSE, warning=FALSE}
pxS5 <- ggplot(mdata.plot2, aes(x = host_environment, y = fitness_av, 
                               color = origin_population)) +  
  geom_pointrange(
    aes(ymin = fitness_av - fitness_se, ymax = fitness_av + fitness_se),
    position = position_dodge(0.4),
    size = 1
  ) +
  facet_wrap(~ year, nrow = 1) +
  scale_color_manual(
    name = "Origin population",
    values = c("#0072B2", "#D55E00"),
    labels = c("Control", "Herbivory"),
    breaks = c("Control", "Herbivory")
  ) +
  scale_shape_manual(
    values = c("con" = 17)  
  ) +
  labs(
    x = "Host environment",
    y = "Relative growth rate"
  ) +
  theme_classic(base_size = 14) +
  theme(
    axis.title.x = element_text(color = "black", size = 14),
    axis.title.y = element_text(color = "black", size = 14),
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_text(color = "black", size = 12),
    strip.text = element_text(face = "bold", size = 12),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid = element_blank(),
    legend.position = "none",
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 12)
  )

pxS5
```

## Statistical analysis for figure S5 (2023)

```{r,echo=FALSE, message=FALSE, warning=FALSE}
model2 <- lmer(rel.count ~ origin_population + host_environment +
                 (1 | pond),
               data = df_filtered2)
Anova(model2, test ="F")
```

